# 2.1 获取源码与环境搭建

> **模型**: claude-opus-4-6 (anthropic/claude-opus-4-6)
> **生成日期**: 2025-02-17

---

## 2.1.1 克隆仓库与分支策略

OpenCode 的源代码托管在 GitHub 上。要开始本书的源码阅读之旅，首先需要获取源码：

```bash
git clone https://github.com/anthropics/opencode.git
cd opencode
```

OpenCode 采用标准的 GitHub Flow 分支策略：

- `main` 分支：稳定的发布分支
- 功能分支：从 `main` 分出，完成后通过 Pull Request 合并回 `main`

建议读者克隆仓库后，切换到一个固定的 Release 标签（如 `v1.1.x`）进行阅读，避免源码在阅读过程中发生变化。本书基于 v1.1.56 版本撰写。

## 2.1.2 Bun 运行时简介与安装

打开 `package.json`，你会注意到一个特别的字段：

```json
{
  "packageManager": "bun@1.3.8"
}
```

OpenCode 使用 **Bun** 作为 JavaScript/TypeScript 运行时，而非更常见的 Node.js。

> **衍生概念：Bun 是什么？**
>
> Bun 是一个用 Zig 语言编写的高性能 JavaScript/TypeScript 运行时。它集成了以下功能于一体：
>
> 1. **JavaScript 运行时**（类似 Node.js）：执行 JS/TS 代码
> 2. **包管理器**（类似 npm/yarn/pnpm）：安装和管理依赖
> 3. **打包器**（类似 webpack/esbuild）：将源码打包为可分发格式
> 4. **测试运行器**（类似 Jest/Vitest）：运行测试
>
> **为什么 OpenCode 选择 Bun 而非 Node.js？**
>
> - **原生 TypeScript 支持**：Bun 可以直接运行 `.ts` 文件，无需编译步骤。这意味着开发时不需要 `tsc` 编译，极大加速了开发体验。
> - **启动速度快**：Bun 的启动时间远低于 Node.js，这对 CLI 工具至关重要——用户每次执行 `opencode` 命令时，快速启动能显著提升体验。
> - **内置功能丰富**：Bun 内置的 Shell API（`$` 模板标签）、Glob、文件 I/O 等功能在 OpenCode 源码中被广泛使用。
> - **兼容 Node.js 生态**：Bun 兼容绝大多数 npm 包，不需要担心生态问题。
>
> 当然，选择 Bun 也有代价——它目前仍在快速迭代中，且 Windows 支持不如 Node.js 成熟。但对于 OpenCode 这种面向开发者的工具来说，这是一个合理的技术赌注。

**安装 Bun**：

```bash
# macOS / Linux
curl -fsSL https://bun.sh/install | bash

# 或通过 Homebrew
brew install oven-sh/bun/bun
```

安装完成后验证：

```bash
bun --version
# 应输出 1.3.8 或更高版本
```

## 2.1.3 依赖安装与首次构建

```bash
# 安装所有依赖
bun install

# 运行开发模式
bun run dev
```

`bun install` 会读取根目录的 `bun.lock`（Bun 的锁文件，类似 npm 的 `package-lock.json`）来安装精确版本的依赖。

项目使用 **Turborepo** 来管理 Monorepo 中各子包的构建任务。`turbo.json` 定义了任务之间的依赖关系：

```json
{
  "tasks": {
    "typecheck": {},
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "opencode#test": {
      "dependsOn": ["^build"],
      "outputs": []
    }
  }
}
```

这里的关键概念：

- `^build` 表示"先构建所有依赖的子包"。例如 `packages/app` 依赖 `packages/ui`，那么在构建 `app` 之前会先构建 `ui`。
- `outputs: ["dist/**"]` 告诉 Turborepo 哪些文件是构建产物，用于缓存——如果源码没变，就跳过构建直接使用缓存。

## 2.1.4 Nix Flake 环境配置

项目根目录下有 `flake.nix` 和 `flake.lock` 文件，说明 OpenCode 也支持通过 Nix 来管理开发环境。

> **衍生概念：Nix 与 Flake**
>
> Nix 是一个纯函数式包管理器。**Nix Flake** 是 Nix 的现代项目管理方式，通过 `flake.nix` 文件声明项目的所有依赖（包括系统级工具），确保每个开发者拥有完全相同的开发环境。
>
> 如果你的机器上安装了 Nix，可以直接运行 `nix develop` 来进入一个包含所有必要工具的 Shell 环境，无需手动安装 Bun 或其他工具。
>
> 这不是使用 OpenCode 的必需条件——大多数读者只需要安装 Bun 即可。

如果你使用 Nix：

```bash
# 进入开发环境（会自动安装所有依赖的系统工具）
nix develop
```
