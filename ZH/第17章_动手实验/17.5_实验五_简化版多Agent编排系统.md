# 17.5 å®éªŒäº”ï¼šå®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆå¤š Agent ç¼–æ’ç³»ç»Ÿ

> **æ¨¡å‹**: claude-opus-4-6 (anthropic/claude-opus-4-6)
> **ç”Ÿæˆæ—¥æœŸ**: 2026-02-18

---

å‰å››ä¸ªå®éªŒè®©æˆ‘ä»¬æŒæ¡äº† AI ç¼–ç¨‹åŠ©æ‰‹çš„æ ¸å¿ƒç»„ä»¶ï¼šLLM å¯¹è¯ã€Tool Useã€MCP æ‰©å±•ã€Plugin æœºåˆ¶ã€‚ä½†çœŸæ­£å¼ºå¤§çš„ AI ç¼–ç¨‹åŠ©æ‰‹ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„ Agent åœ¨å·¥ä½œâ€”â€”è€Œæ˜¯**å¤šä¸ª Agent åä½œ**ã€‚

åœ¨ç¬¬ 15 ç« ï¼Œæˆ‘ä»¬æ·±å…¥å‰–æäº† oh-my-opencode çš„å¤š Agent ä½“ç³»ï¼šSisyphus ä½œä¸ºä¸»ç¼–æ’è€…ã€Oracle æä¾›æŠ€æœ¯å’¨è¯¢ã€Explore è´Ÿè´£ä»£ç æœç´¢ã€Prometheus è§„åˆ’å¤æ‚ä»»åŠ¡â€¦â€¦è¿™ç§**åˆ†å·¥åä½œ**çš„æ¨¡å¼æå¤§åœ°æå‡äº† AI çš„ä»»åŠ¡å®Œæˆèƒ½åŠ›ã€‚

æœ¬èŠ‚æˆ‘ä»¬å°†ä»é›¶æ„å»ºä¸€ä¸ª**ç®€åŒ–ç‰ˆå¤š Agent ç¼–æ’ç³»ç»Ÿ**ï¼Œæ¨¡ä»¿ oh-my-opencode çš„æ ¸å¿ƒæ¶æ„ï¼Œä½“éªŒ Agent ç¼–æ’çš„è®¾è®¡ç²¾é«“ã€‚

## 17.5.1 ç›®æ ‡

æ„å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹ç»„ä»¶çš„å¤š Agent ç³»ç»Ÿï¼š

1. **Commander Agentï¼ˆä¸»ç¼–æ’è€…ï¼‰**ï¼šæ¥æ”¶ç”¨æˆ·ä»»åŠ¡ï¼Œå†³å®šæ˜¯è‡ªå·±å¤„ç†è¿˜æ˜¯å§”æ‰˜ç»™å­ Agent
2. **Researcher Agentï¼ˆç ”ç©¶å‘˜ï¼‰**ï¼šä¸“é—¨è´Ÿè´£ä»£ç æœç´¢å’Œä¿¡æ¯æ”¶é›†
3. **Coder Agentï¼ˆç¼–ç è€…ï¼‰**ï¼šä¸“é—¨è´Ÿè´£ä»£ç ç¼–å†™å’Œä¿®æ”¹
4. **Task å·¥å…·**ï¼šå®ç° Agent é—´çš„ä»»åŠ¡å§”æ‰˜æœºåˆ¶
5. **ä¼šè¯ç®¡ç†**ï¼šç»´æŠ¤æ¯ä¸ª Agent ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡

> **è¡ç”Ÿè§£é‡Šâ€”â€”ä»€ä¹ˆæ˜¯å¤š Agent ç¼–æ’ï¼ˆMulti-Agent Orchestrationï¼‰ï¼Ÿ**
>
> å¤š Agent ç¼–æ’æ˜¯æŒ‡åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­è¿è¡Œå¤šä¸ªå…·æœ‰ä¸åŒèƒ½åŠ›å’Œ"äººæ ¼"çš„ AI Agentï¼Œé€šè¿‡æŸç§åè°ƒæœºåˆ¶è®©å®ƒä»¬åˆ†å·¥åˆä½œå®Œæˆå¤æ‚ä»»åŠ¡ã€‚
>
> è¿™ä¸å• Agent çš„å…³é”®åŒºåˆ«åœ¨äºï¼š
> - **ä¸“ä¸šåŒ–åˆ†å·¥**ï¼šæ¯ä¸ª Agent æœ‰ä¸åŒçš„ System Promptã€å·¥å…·é›†å’Œè¡Œä¸ºçº¦æŸï¼Œå°±åƒå›¢é˜Ÿä¸­çš„ä¸åŒè§’è‰²
> - **æˆæœ¬ä¼˜åŒ–**ï¼šç®€å•ä»»åŠ¡äº¤ç»™è½»é‡ Agentï¼ˆä¾¿å®œçš„æ¨¡å‹ï¼‰ï¼Œå¤æ‚ä»»åŠ¡äº¤ç»™å¼ºåŠ› Agentï¼ˆæ˜‚è´µçš„æ¨¡å‹ï¼‰
> - **å¹¶è¡Œå¤„ç†**ï¼šå¤šä¸ªå­ Agent å¯ä»¥åŒæ—¶å·¥ä½œï¼Œæå‡æ•ˆç‡
> - **ä¸Šä¸‹æ–‡éš”ç¦»**ï¼šæ¯ä¸ª Agent æœ‰ç‹¬ç«‹çš„å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œé¿å…ç›¸äº’å¹²æ‰°
>
> oh-my-opencode çš„åšæ³•ç±»ä¼¼ä¸€ä¸ª"è™šæ‹ŸæŠ€æœ¯å›¢é˜Ÿ"ï¼šSisyphus æ˜¯æŠ€æœ¯è´Ÿè´£äººï¼Œæ ¹æ®ä»»åŠ¡æ€§è´¨åˆ†é…ç»™ä¸åŒçš„ä¸“å®¶ã€‚

## 17.5.2 æ¶æ„è®¾è®¡

åœ¨å¼€å§‹ç¼–ç å‰ï¼Œè®©æˆ‘ä»¬è®¾è®¡ç³»ç»Ÿçš„æ•´ä½“æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·è¾“å…¥                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Commander Agentï¼ˆä¸»ç¼–æ’è€…ï¼‰         â”‚
â”‚                                              â”‚
â”‚  System Prompt: ä»»åŠ¡åˆ†ç±» + å§”æ‰˜å†³ç­–           â”‚
â”‚  å·¥å…·: task, read, edit, bash                â”‚
â”‚                                              â”‚
â”‚  å†³ç­–é€»è¾‘:                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ç®€å•é—®é¢˜ â†’ ç›´æ¥å›ç­”              â”‚        â”‚
â”‚  â”‚ éœ€è¦æœç´¢ â†’ å§”æ‰˜ç»™ Researcher     â”‚        â”‚
â”‚  â”‚ éœ€è¦ç¼–ç  â†’ å§”æ‰˜ç»™ Coder          â”‚        â”‚
â”‚  â”‚ å¤æ‚ä»»åŠ¡ â†’ å…ˆ Researcher å† Coderâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Researcher  â”‚    â”‚    Coder     â”‚
â”‚   Agent      â”‚    â”‚    Agent     â”‚
â”‚              â”‚    â”‚              â”‚
â”‚ å·¥å…·: read,  â”‚    â”‚ å·¥å…·: read,  â”‚
â”‚ glob, grep   â”‚    â”‚ edit, write, â”‚
â”‚              â”‚    â”‚ bash         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ oh-my-opencode çš„å¯¹åº”å…³ç³»

| æˆ‘ä»¬çš„ç³»ç»Ÿ | oh-my-opencode | è§’è‰² |
|-----------|---------------|------|
| Commander | Sisyphus | ä¸»ç¼–æ’è€…ï¼Œè´Ÿè´£ä»»åŠ¡åˆ†ç±»å’Œå§”æ‰˜ |
| Researcher | Explore | ä»£ç æœç´¢ä¸“å®¶ |
| Coder | Hephaestus | ä»£ç ç¼–å†™å·¥åŒ  |
| task å·¥å…· | delegate-task / task | Agent é—´ä»»åŠ¡å§”æ‰˜ |

## 17.5.3 å®ç°æ­¥éª¤

### æ­¥éª¤ä¸€ï¼šé¡¹ç›®åˆå§‹åŒ–ä¸åŸºç¡€ç»“æ„

```bash
mkdir multi-agent-orchestrator
cd multi-agent-orchestrator
bun init -y
bun add ai @ai-sdk/openai zod
```

åˆ›å»ºç›®å½•ç»“æ„ï¼š

```
multi-agent-orchestrator/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ agents/           # Agent å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ commander.ts
â”‚   â”‚   â”œâ”€â”€ researcher.ts
â”‚   â”‚   â””â”€â”€ coder.ts
â”‚   â”œâ”€â”€ tools/            # å·¥å…·å®ç°
â”‚   â”‚   â”œâ”€â”€ file-tools.ts
â”‚   â”‚   â”œâ”€â”€ search-tools.ts
â”‚   â”‚   â””â”€â”€ task-tool.ts
â”‚   â”œâ”€â”€ session/          # ä¼šè¯ç®¡ç†
â”‚   â”‚   â””â”€â”€ manager.ts
â”‚   â””â”€â”€ types.ts          # ç±»å‹å®šä¹‰
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

### æ­¥éª¤äºŒï¼šå®šä¹‰æ ¸å¿ƒç±»å‹

åˆ›å»º `src/types.ts`ï¼š

```typescript
import type { CoreMessage, CoreTool } from "ai"

// Agent å®šä¹‰
export interface AgentDefinition {
  name: string
  description: string
  systemPrompt: string
  tools: Record<string, CoreTool>
  model: string // æ¨¡å‹ ID
  maxSteps: number // æœ€å¤§å·¥å…·è°ƒç”¨è½®æ¬¡
}

// ä¼šè¯è®°å½•
export interface Session {
  id: string
  agentName: string
  messages: CoreMessage[]
  parentSessionId?: string // å…³è”çˆ¶ä¼šè¯
  status: "active" | "completed" | "error"
  result?: string // ä»»åŠ¡ç»“æœ
}

// ä»»åŠ¡å§”æ‰˜è¯·æ±‚
export interface TaskRequest {
  targetAgent: string
  description: string
  context?: string // å¯é€‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
  parentSessionId: string
}
```

è¿™äº›ç±»å‹å¯¹åº”äº†ç¬¬ 4 ç« åˆ†æçš„ OpenCode æ•°æ®æ¨¡å‹ï¼š`AgentDefinition` å¯¹åº” `Agent.Info`ï¼Œ`Session` å¯¹åº” `Session.Info`ï¼Œ`TaskRequest` å¯¹åº” `task` å·¥å…·çš„å‚æ•°ã€‚

### æ­¥éª¤ä¸‰ï¼šå®ç°ä¼šè¯ç®¡ç†å™¨

åˆ›å»º `src/session/manager.ts`â€”â€”ç®¡ç†å¤šä¸ª Agent çš„ç‹¬ç«‹ä¼šè¯ï¼š

```typescript
import type { Session } from "../types"
import { randomUUID } from "crypto"

export class SessionManager {
  private sessions = new Map<string, Session>()

  // åˆ›å»ºæ–°ä¼šè¯
  create(agentName: string, parentSessionId?: string): Session {
    const session: Session = {
      id: `ses_${randomUUID().slice(0, 8)}`,
      agentName,
      messages: [],
      parentSessionId,
      status: "active",
    }
    this.sessions.set(session.id, session)
    return session
  }

  // è·å–ä¼šè¯
  get(sessionId: string): Session | undefined {
    return this.sessions.get(sessionId)
  }

  // è·å–æŒ‡å®šä¼šè¯çš„æ‰€æœ‰å­ä¼šè¯
  getChildren(parentSessionId: string): Session[] {
    return [...this.sessions.values()].filter(
      (s) => s.parentSessionId === parentSessionId
    )
  }

  // å®Œæˆä¼šè¯
  complete(sessionId: string, result: string) {
    const session = this.sessions.get(sessionId)
    if (session) {
      session.status = "completed"
      session.result = result
    }
  }

  // åˆ—å‡ºæ‰€æœ‰ä¼šè¯
  list(): Session[] {
    return [...this.sessions.values()]
  }
}
```

è¿™ä¸ªè®¾è®¡æ¨¡ä»¿äº† OpenCode ä¸­ Session çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆç¬¬ 4.1 èŠ‚ï¼‰ï¼š

- **`parentSessionId`**ï¼šå®ç°çˆ¶å­ä¼šè¯å…³è”ã€‚å½“ Commander å§”æ‰˜ä»»åŠ¡ç»™ Researcher æ—¶ï¼ŒResearcher çš„ä¼šè¯ä¼šè®°å½• Commander çš„ä¼šè¯ IDï¼Œå½¢æˆå±‚çº§å…³ç³»ã€‚
- **ç‹¬ç«‹çš„ `messages` æ•°ç»„**ï¼šæ¯ä¸ª Agent æœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼Œäº’ä¸å¹²æ‰°ã€‚
- **`status` çŠ¶æ€æœº**ï¼š`active` â†’ `completed`/`error`ï¼Œå¯¹åº” OpenCode çš„ `SessionStatus`ã€‚

### æ­¥éª¤å››ï¼šå®šä¹‰ Agent

åˆ›å»º `src/agents/researcher.ts`â€”â€”ç ”ç©¶å‘˜ Agentï¼š

```typescript
import type { AgentDefinition } from "../types"
import { createSearchTools } from "../tools/search-tools"

export function createResearcher(workDir: string): AgentDefinition {
  return {
    name: "researcher",
    description: "ä»£ç åº“æœç´¢ä¸“å®¶ï¼Œæ“…é•¿å¿«é€Ÿå®šä½æ–‡ä»¶å’Œä»£ç ç‰‡æ®µ",
    model: "gpt-4o-mini", // ä½¿ç”¨ä¾¿å®œçš„æ¨¡å‹ï¼Œå› ä¸ºæœç´¢ä»»åŠ¡ç›¸å¯¹ç®€å•
    maxSteps: 10,
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªä»£ç åº“æœç´¢ä¸“å®¶ï¼ˆResearcherï¼‰ã€‚ä½ çš„èŒè´£æ˜¯ï¼š

1. é«˜æ•ˆåœ°æœç´¢å’Œå®šä½ä»£ç æ–‡ä»¶
2. é˜…è¯»å¹¶ç†è§£ä»£ç å†…å®¹
3. æ•´ç†æœç´¢ç»“æœï¼Œç”¨ç»“æ„åŒ–çš„æ–¹å¼æ±‡æŠ¥

## è¡Œä¸ºè§„èŒƒ

- åªä½¿ç”¨ readã€globã€grep å·¥å…·ï¼Œä¸è¦ä¿®æ”¹ä»»ä½•æ–‡ä»¶
- æœç´¢ç»“æœè¦åŒ…å«æ–‡ä»¶è·¯å¾„å’Œå…³é”®ä»£ç ç‰‡æ®µ
- å¦‚æœæ‰¾ä¸åˆ°ç›¸å…³å†…å®¹ï¼Œæ˜ç¡®è¯´æ˜è€Œä¸æ˜¯çŒœæµ‹
- å›å¤è¦ç®€æ´ã€ç»“æ„åŒ–ï¼Œæ–¹ä¾¿è°ƒç”¨è€…ä½¿ç”¨

## è¾“å‡ºæ ¼å¼

æœç´¢å®Œæˆåï¼ŒæŒ‰ä»¥ä¸‹æ ¼å¼æ±‡æŠ¥ï¼š
- æ‰¾åˆ°çš„æ–‡ä»¶åˆ—è¡¨åŠå„è‡ªçš„ç”¨é€”
- å…³é”®ä»£ç ç‰‡æ®µï¼ˆæ ‡æ³¨è¡Œå·ï¼‰
- ä½ çš„åˆ†æå’Œå»ºè®®`,
    tools: createSearchTools(workDir),
  }
}
```

åˆ›å»º `src/agents/coder.ts`â€”â€”ç¼–ç è€… Agentï¼š

```typescript
import type { AgentDefinition } from "../types"
import { createFileTools } from "../tools/file-tools"

export function createCoder(workDir: string): AgentDefinition {
  return {
    name: "coder",
    description: "ä»£ç ç¼–å†™å·¥åŒ ï¼Œæ“…é•¿å®ç°åŠŸèƒ½å’Œä¿®å¤ Bug",
    model: "gpt-4o", // ä½¿ç”¨æ›´å¼ºçš„æ¨¡å‹ï¼Œå› ä¸ºç¼–ç éœ€è¦æ›´é«˜çš„æ¨ç†èƒ½åŠ›
    maxSteps: 20,
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªä»£ç ç¼–å†™å·¥åŒ ï¼ˆCoderï¼‰ã€‚ä½ çš„èŒè´£æ˜¯ï¼š

1. æ ¹æ®ä»»åŠ¡æè¿°ç¼–å†™æˆ–ä¿®æ”¹ä»£ç 
2. ç¡®ä¿ä»£ç è´¨é‡â€”â€”éµå¾ªé¡¹ç›®çš„ç°æœ‰é£æ ¼å’Œæœ€ä½³å®è·µ
3. å®Œæˆåç®€è¦è¯´æ˜æ‰€åšçš„æ›´æ”¹

## è¡Œä¸ºè§„èŒƒ

- ä¿®æ”¹æ–‡ä»¶å‰å…ˆé˜…è¯»ç°æœ‰å†…å®¹
- ä½¿ç”¨ edit å·¥å…·åšç²¾ç¡®æ›¿æ¢ï¼Œè€Œé write é‡å†™æ•´ä¸ªæ–‡ä»¶
- ä¸è¦å¼•å…¥ä¸å¿…è¦çš„ä¾èµ–
- ä»£ç é£æ ¼è¦ä¸é¡¹ç›®ä¿æŒä¸€è‡´
- å®ŒæˆåæŠ¥å‘Šä¿®æ”¹äº†å“ªäº›æ–‡ä»¶ã€æ¯ä¸ªæ–‡ä»¶çš„å˜æ›´æ‘˜è¦

## å®‰å…¨è§„åˆ™

- ä¸è¦æ‰§è¡Œå±é™©å‘½ä»¤ï¼ˆrm -rfã€git push --force ç­‰ï¼‰
- ä¸è¦ä¿®æ”¹ .env æˆ–åŒ…å«å¯†é’¥çš„æ–‡ä»¶
- å¦‚æœä»»åŠ¡ä¸æ¸…æ¥šï¼Œå®å¯ä¸åšä¹Ÿä¸è¦çŒœæµ‹æ€§åœ°ä¿®æ”¹ä»£ç `,
    tools: createFileTools(workDir),
  }
}
```

åˆ›å»º `src/agents/commander.ts`â€”â€”ä¸»ç¼–æ’è€… Agentï¼š

```typescript
import type { AgentDefinition } from "../types"
import { createFileTools } from "../tools/file-tools"
import { createSearchTools } from "../tools/search-tools"
import { createTaskTool } from "../tools/task-tool"
import type { SessionManager } from "../session/manager"

export function createCommander(
  workDir: string,
  sessionManager: SessionManager,
  executeAgent: (agentName: string, task: string, parentSessionId: string) => Promise<string>
): AgentDefinition {
  return {
    name: "commander",
    description: "ä¸»ç¼–æ’è€…ï¼Œè´Ÿè´£ç†è§£ç”¨æˆ·æ„å›¾å¹¶åˆ†é…ä»»åŠ¡",
    model: "gpt-4o",
    maxSteps: 30,
    systemPrompt: `ä½ æ˜¯ Commanderâ€”â€”ä¸€ä¸ª AI ç¼–ç¨‹å›¢é˜Ÿçš„æŠ€æœ¯è´Ÿè´£äººã€‚ä½ çš„å›¢é˜Ÿæœ‰ä»¥ä¸‹æˆå‘˜ï¼š

## å›¢é˜Ÿæˆå‘˜

| Agent | æ“…é•¿ | æˆæœ¬ | ä½•æ—¶ä½¿ç”¨ |
|-------|------|------|---------|
| researcher | ä»£ç æœç´¢ã€æ–‡ä»¶å®šä½ | ä½ | éœ€è¦æŸ¥æ‰¾ä»£ç ã€ç†è§£é¡¹ç›®ç»“æ„æ—¶ |
| coder | ä»£ç ç¼–å†™ã€Bug ä¿®å¤ | é«˜ | éœ€è¦å®é™…ç¼–å†™æˆ–ä¿®æ”¹ä»£ç æ—¶ |

## å†³ç­–æµç¨‹

1. **åˆ†æç”¨æˆ·æ„å›¾**ï¼šç†è§£ç”¨æˆ·æƒ³è¦ä»€ä¹ˆ
2. **åˆ¤æ–­å¤æ‚åº¦**ï¼š
   - ç®€å•é—®é¢˜ï¼ˆå¦‚è§£é‡Šæ¦‚å¿µï¼‰â†’ ç›´æ¥å›ç­”ï¼Œä¸å§”æ‰˜
   - éœ€è¦æœç´¢ä»£ç  â†’ å§”æ‰˜ç»™ researcher
   - éœ€è¦ç¼–å†™ä»£ç  â†’ å§”æ‰˜ç»™ coder
   - å¤æ‚ä»»åŠ¡ â†’ å…ˆè®© researcher æœç´¢ï¼Œå†è®© coder ç¼–å†™
3. **å§”æ‰˜ä»»åŠ¡**ï¼šä½¿ç”¨ task å·¥å…·å§”æ‰˜ç»™åˆé€‚çš„ Agent
4. **æ•´åˆç»“æœ**ï¼šæ±‡æ€»å„ Agent çš„ç»“æœï¼Œç»™ç”¨æˆ·å®Œæ•´çš„ç­”å¤

## å§”æ‰˜åè®®

ä½¿ç”¨ task å·¥å…·æ—¶ï¼Œdescription è¦åŒ…å«ï¼š
- TASKï¼šå…·ä½“ä»»åŠ¡æè¿°
- CONTEXTï¼šå¿…è¦çš„èƒŒæ™¯ä¿¡æ¯
- EXPECTED_OUTCOMEï¼šæœŸæœ›çš„è¾“å‡ºæ ¼å¼

## é‡è¦åŸåˆ™

- æˆæœ¬æ„è¯†ï¼šç®€å•æœç´¢ç”¨ researcherï¼ˆä¾¿å®œï¼‰ï¼Œä¸è¦ç”¨ coder
- ä¸è¦åŒæ—¶å§”æ‰˜å¤šä¸ªç›¸äº’ä¾èµ–çš„ä»»åŠ¡â€”â€”ç­‰å‰ä¸€ä¸ªå®Œæˆå†å§”æ‰˜ä¸‹ä¸€ä¸ª
- å¦‚æœå­ Agent å¤±è´¥äº†ï¼Œå°è¯•æ¢ä¸€ç§æ–¹å¼é‡æ–°å§”æ‰˜æˆ–è‡ªå·±å¤„ç†
- å§‹ç»ˆç»™ç”¨æˆ·æ¸…æ™°çš„æœ€ç»ˆç­”å¤ï¼Œä¸è¦åªè½¬å‘å­ Agent çš„åŸå§‹è¾“å‡º`,
    tools: {
      ...createFileTools(workDir),
      ...createSearchTools(workDir),
      ...createTaskTool(sessionManager, executeAgent),
    },
  }
}
```

æ³¨æ„ Commander çš„ System Prompt è®¾è®¡â€”â€”å®ƒæ¨¡ä»¿äº† oh-my-opencode ä¸­ Sisyphus çš„æ ¸å¿ƒç†å¿µï¼ˆç¬¬ 15.3.3 èŠ‚ï¼‰ï¼š

1. **æ„å›¾åˆ†ç±»**ï¼šåˆ†æä»»åŠ¡å¤æ‚åº¦ï¼Œç±»ä¼¼ Sisyphus çš„ Trivial/Explicit/Exploratory/Open-ended åˆ†ç±»
2. **å§”æ‰˜åè®®**ï¼šç»“æ„åŒ–çš„ä»»åŠ¡æè¿°æ ¼å¼ï¼Œç±»ä¼¼ Sisyphus çš„ 6 æ®µå§”æ‰˜ç»“æ„
3. **æˆæœ¬æ„è¯†**ï¼šåŒºåˆ†å“ªäº›ä»»åŠ¡ç”¨ä¾¿å®œçš„ Agentï¼Œå“ªäº›ç”¨æ˜‚è´µçš„ Agent
4. **é”™è¯¯æ¢å¤**ï¼šå­ Agent å¤±è´¥æ—¶çš„å…œåº•ç­–ç•¥

### æ­¥éª¤äº”ï¼šå®ç°å·¥å…·é›†

åˆ›å»º `src/tools/search-tools.ts`ï¼š

```typescript
import { z } from "zod"
import type { CoreTool } from "ai"
import * as fs from "fs"
import * as path from "path"
import { execSync } from "child_process"

export function createSearchTools(workDir: string): Record<string, CoreTool> {
  return {
    read: {
      description: "è¯»å–æ–‡ä»¶å†…å®¹ã€‚è¿”å›å¸¦è¡Œå·çš„æ–‡ä»¶å†…å®¹ã€‚",
      parameters: z.object({
        file_path: z.string().describe("è¦è¯»å–çš„æ–‡ä»¶è·¯å¾„"),
        offset: z.number().optional().describe("èµ·å§‹è¡Œå·ï¼ˆä» 1 å¼€å§‹ï¼‰"),
        limit: z.number().optional().describe("è¯»å–çš„è¡Œæ•°é™åˆ¶"),
      }),
      execute: async (args) => {
        try {
          const fullPath = path.resolve(workDir, args.file_path)
          const content = fs.readFileSync(fullPath, "utf-8")
          const lines = content.split("\n")

          const start = (args.offset || 1) - 1
          const end = args.limit ? start + args.limit : lines.length
          const selectedLines = lines.slice(start, end)

          return selectedLines
            .map((line, i) => `${start + i + 1}\t${line}`)
            .join("\n")
        } catch (error) {
          return `Error: ${error instanceof Error ? error.message : String(error)}`
        }
      },
    },

    glob: {
      description: "ä½¿ç”¨ glob æ¨¡å¼æœç´¢æ–‡ä»¶ã€‚è¿”å›åŒ¹é…çš„æ–‡ä»¶è·¯å¾„åˆ—è¡¨ã€‚",
      parameters: z.object({
        pattern: z.string().describe("glob æ¨¡å¼ï¼Œå¦‚ '**/*.ts' æˆ– 'src/**/*.tsx'"),
      }),
      execute: async (args) => {
        try {
          const glob = new Bun.Glob(args.pattern)
          const matches: string[] = []
          for await (const file of glob.scan({ cwd: workDir })) {
            if (!file.includes("node_modules") && !file.includes(".git")) {
              matches.push(file)
            }
          }
          return matches.length > 0
            ? matches.join("\n")
            : "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶"
        } catch (error) {
          return `Error: ${error instanceof Error ? error.message : String(error)}`
        }
      },
    },

    grep: {
      description: "åœ¨æ–‡ä»¶å†…å®¹ä¸­æœç´¢æ­£åˆ™è¡¨è¾¾å¼ã€‚è¿”å›åŒ¹é…çš„æ–‡ä»¶å’Œè¡Œã€‚",
      parameters: z.object({
        pattern: z.string().describe("æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼"),
        include: z.string().optional().describe("æ–‡ä»¶æ¨¡å¼è¿‡æ»¤ï¼Œå¦‚ '*.ts'"),
      }),
      execute: async (args) => {
        try {
          const includeArg = args.include ? `--include='${args.include}'` : ""
          const result = execSync(
            `grep -rn ${includeArg} '${args.pattern}' . 2>/dev/null | head -50`,
            { cwd: workDir, encoding: "utf-8", timeout: 10000 }
          )
          return result || "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…å†…å®¹"
        } catch {
          return "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…å†…å®¹"
        }
      },
    },
  }
}
```

åˆ›å»º `src/tools/file-tools.ts`ï¼š

```typescript
import { z } from "zod"
import type { CoreTool } from "ai"
import * as fs from "fs"
import * as path from "path"
import { execSync } from "child_process"

export function createFileTools(workDir: string): Record<string, CoreTool> {
  // åŒ…å«æœç´¢å·¥å…·çš„åŸºç¡€åŠŸèƒ½
  const searchTools = (await import("./search-tools")).createSearchTools(workDir)

  return {
    // ç»§æ‰¿ read å·¥å…·
    read: searchTools.read,

    edit: {
      description:
        "ç²¾ç¡®æ›¿æ¢æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚old_string å¿…é¡»åœ¨æ–‡ä»¶ä¸­å”¯ä¸€å­˜åœ¨ã€‚",
      parameters: z.object({
        file_path: z.string().describe("è¦ç¼–è¾‘çš„æ–‡ä»¶è·¯å¾„"),
        old_string: z.string().describe("è¦æ›¿æ¢çš„åŸå§‹æ–‡æœ¬"),
        new_string: z.string().describe("æ›¿æ¢åçš„æ–°æ–‡æœ¬"),
      }),
      execute: async (args) => {
        try {
          const fullPath = path.resolve(workDir, args.file_path)
          const content = fs.readFileSync(fullPath, "utf-8")

          // æ£€æŸ¥ old_string æ˜¯å¦å”¯ä¸€å­˜åœ¨
          const count = content.split(args.old_string).length - 1
          if (count === 0) {
            return `Error: old_string åœ¨æ–‡ä»¶ä¸­ä¸å­˜åœ¨`
          }
          if (count > 1) {
            return `Error: old_string åœ¨æ–‡ä»¶ä¸­å‡ºç°äº† ${count} æ¬¡ï¼Œå¿…é¡»å”¯ä¸€`
          }

          // æ‰§è¡Œæ›¿æ¢
          const newContent = content.replace(args.old_string, args.new_string)
          fs.writeFileSync(fullPath, newContent)
          return `å·²æˆåŠŸç¼–è¾‘ ${args.file_path}`
        } catch (error) {
          return `Error: ${error instanceof Error ? error.message : String(error)}`
        }
      },
    },

    write: {
      description: "å°†å†…å®¹å†™å…¥æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ä¼šè¢«è¦†ç›–ã€‚",
      parameters: z.object({
        file_path: z.string().describe("è¦å†™å…¥çš„æ–‡ä»¶è·¯å¾„"),
        content: z.string().describe("æ–‡ä»¶å†…å®¹"),
      }),
      execute: async (args) => {
        try {
          const fullPath = path.resolve(workDir, args.file_path)
          // ç¡®ä¿ç›®å½•å­˜åœ¨
          fs.mkdirSync(path.dirname(fullPath), { recursive: true })
          fs.writeFileSync(fullPath, args.content)
          return `å·²æˆåŠŸå†™å…¥ ${args.file_path}`
        } catch (error) {
          return `Error: ${error instanceof Error ? error.message : String(error)}`
        }
      },
    },

    bash: {
      description: "æ‰§è¡Œ Shell å‘½ä»¤ã€‚ç”¨äºè¿è¡Œæµ‹è¯•ã€å®‰è£…ä¾èµ–ç­‰æ“ä½œã€‚",
      parameters: z.object({
        command: z.string().describe("è¦æ‰§è¡Œçš„å‘½ä»¤"),
      }),
      execute: async (args) => {
        // å®‰å…¨æ£€æŸ¥ï¼šç¦æ­¢å±é™©å‘½ä»¤
        const dangerous = ["rm -rf /", "git push --force", ":(){ :|:& };:"]
        if (dangerous.some((d) => args.command.includes(d))) {
          return "Error: è¯¥å‘½ä»¤è¢«å®‰å…¨ç­–ç•¥ç¦æ­¢"
        }

        try {
          const result = execSync(args.command, {
            cwd: workDir,
            encoding: "utf-8",
            timeout: 30000, // 30 ç§’è¶…æ—¶
          })
          return result.slice(0, 10000) // æˆªæ–­è¿‡é•¿è¾“å‡º
        } catch (error) {
          return `å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${error instanceof Error ? error.message : String(error)}`
        }
      },
    },
  }
}
```

### æ­¥éª¤å…­ï¼šå®ç° Task å·¥å…·ï¼ˆæ ¸å¿ƒï¼‰

åˆ›å»º `src/tools/task-tool.ts`â€”â€”è¿™æ˜¯å®ç° Agent ç¼–æ’çš„å…³é”®ï¼š

```typescript
import { z } from "zod"
import type { CoreTool } from "ai"
import type { SessionManager } from "../session/manager"

export function createTaskTool(
  sessionManager: SessionManager,
  executeAgent: (agentName: string, task: string, parentSessionId: string) => Promise<string>
): Record<string, CoreTool> {
  return {
    task: {
      description: `å°†ä»»åŠ¡å§”æ‰˜ç»™ä¸“é—¨çš„å­ Agent æ‰§è¡Œã€‚å¯ç”¨çš„ Agentï¼š
- researcherï¼šä»£ç æœç´¢å’Œä¿¡æ¯æ”¶é›†ä¸“å®¶ï¼ˆæˆæœ¬ä½ï¼‰
- coderï¼šä»£ç ç¼–å†™å’Œä¿®æ”¹ä¸“å®¶ï¼ˆæˆæœ¬é«˜ï¼‰

ä½¿ç”¨æ—¶æœºï¼šå½“ä»»åŠ¡éœ€è¦ä¸“ä¸šèƒ½åŠ›æ—¶å§”æ‰˜ï¼Œç®€å•é—®é¢˜ç›´æ¥å›ç­”ä¸è¦å§”æ‰˜ã€‚`,
      parameters: z.object({
        agent: z.enum(["researcher", "coder"]).describe("ç›®æ ‡ Agent åç§°"),
        description: z.string().describe(
          "è¯¦ç»†çš„ä»»åŠ¡æè¿°ã€‚æ ¼å¼ï¼šTASK: ä»»åŠ¡ | CONTEXT: ä¸Šä¸‹æ–‡ | EXPECTED_OUTCOME: æœŸæœ›è¾“å‡º"
        ),
      }),
      execute: async (args) => {
        console.log(`\nğŸ“‹ Commander å§”æ‰˜ä»»åŠ¡ç»™ ${args.agent}:`)
        console.log(`   ${args.description.slice(0, 100)}...`)

        try {
          // è·å–å½“å‰ Commander çš„ä¼šè¯ ID
          const commanderSession = [...sessionManager.list()]
            .filter((s) => s.agentName === "commander" && s.status === "active")
            .pop()

          const parentId = commanderSession?.id || "root"

          // æ‰§è¡Œå­ Agent
          const result = await executeAgent(args.agent, args.description, parentId)

          console.log(`âœ… ${args.agent} å®Œæˆä»»åŠ¡`)
          return `[${args.agent} çš„æ‰§è¡Œç»“æœ]\n\n${result}`
        } catch (error) {
          console.log(`âŒ ${args.agent} æ‰§è¡Œå¤±è´¥`)
          return `[${args.agent} æ‰§è¡Œå¤±è´¥] ${error instanceof Error ? error.message : String(error)}`
        }
      },
    },
  }
}
```

è¿™ä¸ª `task` å·¥å…·çš„è®¾è®¡ç›´æ¥å¯¹åº”äº† OpenCode ä¸­ `tool/task.ts` çš„æ ¸å¿ƒæ€æƒ³ï¼ˆç¬¬ 5.3.5 èŠ‚ï¼‰ï¼š

- **åˆ›å»ºå­ä¼šè¯**ï¼šé€šè¿‡ `sessionManager.create()` ä¸ºå­ Agent åˆ›å»ºç‹¬ç«‹çš„ä¼šè¯
- **Agent æƒé™è¿‡æ»¤**ï¼šé€šè¿‡ `z.enum(["researcher", "coder"])` é™åˆ¶å¯å§”æ‰˜çš„ç›®æ ‡
- **ç»“æœå›ä¼ **ï¼šå­ Agent çš„æ‰§è¡Œç»“æœä½œä¸º `task` å·¥å…·çš„è¿”å›å€¼ï¼Œå›åˆ° Commander çš„ä¸Šä¸‹æ–‡ä¸­

### æ­¥éª¤ä¸ƒï¼šå®ç°æ ¸å¿ƒæ‰§è¡Œå¼•æ“

åˆ›å»º `src/index.ts`â€”â€”æŠŠæ‰€æœ‰ç»„ä»¶ç»„è£…åœ¨ä¸€èµ·ï¼š

```typescript
import { streamText } from "ai"
import { openai } from "@ai-sdk/openai"
import { createInterface } from "readline"
import { SessionManager } from "./session/manager"
import { createCommander } from "./agents/commander"
import { createResearcher } from "./agents/researcher"
import { createCoder } from "./agents/coder"
import type { AgentDefinition, Session } from "./types"
import type { CoreMessage } from "ai"

// ===== å…¨å±€çŠ¶æ€ =====
const sessionManager = new SessionManager()
const workDir = process.cwd()

// ===== Agent æ‰§è¡Œå¼•æ“ =====
async function executeAgent(
  agentName: string,
  task: string,
  parentSessionId: string
): Promise<string> {
  // æŸ¥æ‰¾ Agent å®šä¹‰
  const agent = agents[agentName]
  if (!agent) {
    throw new Error(`æœªçŸ¥çš„ Agent: ${agentName}`)
  }

  // åˆ›å»ºå­ä¼šè¯
  const session = sessionManager.create(agentName, parentSessionId)
  console.log(`\nğŸ”„ [${agentName}] å¼€å§‹æ‰§è¡Œ (session: ${session.id})`)

  // åˆå§‹åŒ–æ¶ˆæ¯
  session.messages = [
    { role: "user", content: task },
  ]

  // Agentic Loopï¼šæŒç»­è°ƒç”¨ LLM ç›´åˆ°æ²¡æœ‰å·¥å…·è°ƒç”¨
  let steps = 0
  let finalText = ""

  while (steps < agent.maxSteps) {
    steps++

    const result = await streamText({
      model: openai(agent.model),
      system: agent.systemPrompt,
      messages: session.messages,
      tools: agent.tools,
      maxSteps: 1, // æ¯æ¬¡åªæ‰§è¡Œä¸€æ­¥ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ§åˆ¶å¾ªç¯
    })

    // æ”¶é›†å®Œæ•´å“åº”
    let text = ""
    const toolCalls: any[] = []
    const toolResults: any[] = []

    for await (const part of result.fullStream) {
      if (part.type === "text-delta") {
        text += part.textDelta
      }
      if (part.type === "tool-call") {
        toolCalls.push(part)
      }
      if (part.type === "tool-result") {
        toolResults.push(part)
      }
    }

    // æ›´æ–°ä¼šè¯æ¶ˆæ¯
    if (text) {
      session.messages.push({ role: "assistant", content: text })
      finalText = text
    }

    // å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼ŒAgent å®Œæˆäº†ä»»åŠ¡
    if (toolCalls.length === 0) {
      break
    }

    // å°†å·¥å…·è°ƒç”¨å’Œç»“æœæ·»åŠ åˆ°æ¶ˆæ¯å†å²
    session.messages.push({
      role: "assistant",
      content: toolCalls.map((tc) => ({
        type: "tool-call" as const,
        toolCallId: tc.toolCallId,
        toolName: tc.toolName,
        args: tc.args,
      })),
    })

    session.messages.push({
      role: "tool",
      content: toolResults.map((tr) => ({
        type: "tool-result" as const,
        toolCallId: tr.toolCallId,
        toolName: tr.toolName,
        result: tr.result,
      })),
    })

    console.log(
      `   [${agentName}] æ­¥éª¤ ${steps}: è°ƒç”¨äº† ${toolCalls.map((t) => t.toolName).join(", ")}`
    )
  }

  // å®Œæˆä¼šè¯
  sessionManager.complete(session.id, finalText)
  console.log(`âœ… [${agentName}] å®Œæˆ (${steps} æ­¥)`)
  return finalText
}

// ===== Agent æ³¨å†Œè¡¨ =====
const agents: Record<string, AgentDefinition> = {}

function registerAgents() {
  const researcher = createResearcher(workDir)
  const coder = createCoder(workDir)
  const commander = createCommander(workDir, sessionManager, executeAgent)

  agents[researcher.name] = researcher
  agents[coder.name] = coder
  agents[commander.name] = commander
}

// ===== ä¸»äº¤äº’å¾ªç¯ =====
async function main() {
  registerAgents()
  const commanderSession = sessionManager.create("commander")

  console.log("ğŸ¤– å¤š Agent ç¼–æ’ç³»ç»Ÿå·²å¯åŠ¨")
  console.log("   Commanderï¼ˆä¸»ç¼–æ’è€…ï¼‰å·²å°±ç»ª")
  console.log("   å¯ç”¨çš„å­ Agentï¼šresearcher, coder")
  console.log("   è¾“å…¥ /sessions æŸ¥çœ‹ä¼šè¯çŠ¶æ€")
  console.log("   è¾“å…¥ /quit é€€å‡º\n")

  const rl = createInterface({
    input: process.stdin,
    output: process.stdout,
  })

  const prompt = () => {
    rl.question("ä½ > ", async (input) => {
      const trimmed = input.trim()

      if (!trimmed) {
        prompt()
        return
      }

      // å†…ç½®å‘½ä»¤
      if (trimmed === "/quit") {
        console.log("å†è§ï¼")
        rl.close()
        return
      }

      if (trimmed === "/sessions") {
        const sessions = sessionManager.list()
        console.log("\nğŸ“Š ä¼šè¯åˆ—è¡¨:")
        for (const s of sessions) {
          console.log(
            `   ${s.id} | ${s.agentName} | ${s.status} | æ¶ˆæ¯æ•°: ${s.messages.length} | çˆ¶: ${s.parentSessionId || "æ— "}`
          )
        }
        console.log()
        prompt()
        return
      }

      // å‘é€ç»™ Commander Agent
      try {
        commanderSession.messages.push({ role: "user", content: trimmed })

        const commander = agents["commander"]
        let steps = 0
        let lastText = ""

        // Commander çš„ Agentic Loop
        while (steps < commander.maxSteps) {
          steps++

          const result = await streamText({
            model: openai(commander.model),
            system: commander.systemPrompt,
            messages: commanderSession.messages,
            tools: commander.tools,
            maxSteps: 1,
          })

          let text = ""
          const toolCalls: any[] = []
          const toolResults: any[] = []

          // æµå¼è¾“å‡º Commander çš„æ–‡æœ¬å“åº”
          for await (const part of result.fullStream) {
            if (part.type === "text-delta") {
              process.stdout.write(part.textDelta)
              text += part.textDelta
            }
            if (part.type === "tool-call") {
              toolCalls.push(part)
            }
            if (part.type === "tool-result") {
              toolResults.push(part)
            }
          }

          if (text) {
            commanderSession.messages.push({
              role: "assistant",
              content: text,
            })
            lastText = text
          }

          if (toolCalls.length === 0) break

          // æ·»åŠ å·¥å…·è°ƒç”¨å†å²
          commanderSession.messages.push({
            role: "assistant",
            content: toolCalls.map((tc) => ({
              type: "tool-call" as const,
              toolCallId: tc.toolCallId,
              toolName: tc.toolName,
              args: tc.args,
            })),
          })

          commanderSession.messages.push({
            role: "tool",
            content: toolResults.map((tr) => ({
              type: "tool-result" as const,
              toolCallId: tr.toolCallId,
              toolName: tr.toolName,
              result: tr.result,
            })),
          })
        }

        console.log("\n")
      } catch (error) {
        console.error(
          "âŒ é”™è¯¯:",
          error instanceof Error ? error.message : String(error)
        )
      }

      prompt()
    })
  }

  prompt()
}

main().catch(console.error)
```

### æ­¥éª¤å…«ï¼šè¿è¡Œä¸æµ‹è¯•

```bash
# è®¾ç½® API Key
export OPENAI_API_KEY="your-key-here"

# è¿è¡Œ
bun run src/index.ts
```

æµ‹è¯•åœºæ™¯ï¼š

```
ä½ > å¸®æˆ‘çœ‹çœ‹è¿™ä¸ªé¡¹ç›®çš„ç›®å½•ç»“æ„å’Œä¸»è¦æ–‡ä»¶

ğŸ”„ [researcher] å¼€å§‹æ‰§è¡Œ (session: ses_a1b2c3)
   [researcher] æ­¥éª¤ 1: è°ƒç”¨äº† glob
   [researcher] æ­¥éª¤ 2: è°ƒç”¨äº† read
âœ… [researcher] å®Œæˆ (3 æ­¥)

Commander: æ ¹æ® Researcher çš„åˆ†æï¼Œè¿™ä¸ªé¡¹ç›®çš„ç»“æ„å¦‚ä¸‹...
```

```
ä½ > åœ¨ src/utils/ ä¸‹åˆ›å»ºä¸€ä¸ª format-date.ts æ–‡ä»¶ï¼Œå®ç°æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°

ğŸ”„ [coder] å¼€å§‹æ‰§è¡Œ (session: ses_d4e5f6)
   [coder] æ­¥éª¤ 1: è°ƒç”¨äº† write
âœ… [coder] å®Œæˆ (1 æ­¥)

Commander: Coder å·²ç»åˆ›å»ºäº† src/utils/format-date.ts...
```

```
ä½ > /sessions
ğŸ“Š ä¼šè¯åˆ—è¡¨:
   ses_main01 | commander | active | æ¶ˆæ¯æ•°: 8 | çˆ¶: æ— 
   ses_a1b2c3 | researcher | completed | æ¶ˆæ¯æ•°: 6 | çˆ¶: ses_main01
   ses_d4e5f6 | coder | completed | æ¶ˆæ¯æ•°: 4 | çˆ¶: ses_main01
```

## 17.5.4 è¿›é˜¶ï¼šæ·»åŠ å¹¶è¡Œä»»åŠ¡æ‰§è¡Œ

oh-my-opencode çš„åå° Agent ç³»ç»Ÿï¼ˆç¬¬ 15.6.1 èŠ‚ï¼‰æ”¯æŒ**å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå­ Agent**ã€‚è®©æˆ‘ä»¬ä¸ºç³»ç»Ÿæ·»åŠ è¿™ä¸ªèƒ½åŠ›ï¼š

```typescript
// src/tools/task-tool.ts ä¸­å¢åŠ  parallel_tasks å·¥å…·

parallel_tasks: {
  description: "å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå­ Agent ä»»åŠ¡ã€‚æ‰€æœ‰ä»»åŠ¡åŒæ—¶å¯åŠ¨ï¼Œç­‰å¾…å…¨éƒ¨å®Œæˆåè¿”å›ç»“æœã€‚",
  parameters: z.object({
    tasks: z.array(z.object({
      agent: z.enum(["researcher", "coder"]),
      description: z.string(),
    })).describe("è¦å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨"),
  }),
  execute: async (args) => {
    console.log(`\nğŸ”€ å¹¶è¡Œæ‰§è¡Œ ${args.tasks.length} ä¸ªä»»åŠ¡...`)

    const commanderSession = [...sessionManager.list()]
      .filter((s) => s.agentName === "commander" && s.status === "active")
      .pop()
    const parentId = commanderSession?.id || "root"

    // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
    const results = await Promise.allSettled(
      args.tasks.map((task, i) =>
        executeAgent(task.agent, task.description, parentId)
          .then((result) => ({ index: i, agent: task.agent, result }))
      )
    )

    // æ•´ç†ç»“æœ
    const output = results.map((r, i) => {
      if (r.status === "fulfilled") {
        return `### ä»»åŠ¡ ${i + 1} (${r.value.agent}) â€” æˆåŠŸ\n${r.value.result}`
      } else {
        return `### ä»»åŠ¡ ${i + 1} (${args.tasks[i].agent}) â€” å¤±è´¥\n${r.reason}`
      }
    })

    return output.join("\n\n---\n\n")
  },
},
```

ä½¿ç”¨ `Promise.allSettled` è€Œé `Promise.all`ï¼Œè¿™æ ·å³ä½¿æŸä¸ªå­ Agent å¤±è´¥ï¼Œå…¶ä»–ä»»åŠ¡ä¹Ÿèƒ½æ­£å¸¸å®Œæˆâ€”â€”è¿™æ­£æ˜¯ oh-my-opencode çš„**é˜²å¾¡å¼ç¼–ç¨‹**ç†å¿µã€‚

## 17.5.5 è¿›é˜¶ï¼šDoom Loop æ£€æµ‹

å›é¡¾ç¬¬ 4.4.2 èŠ‚åˆ†æçš„ Doom Loop æ£€æµ‹æœºåˆ¶â€”â€”å½“ Agent åå¤è°ƒç”¨åŒä¸€ä¸ªå·¥å…·å¾—åˆ°ç›¸åŒç»“æœæ—¶ï¼Œè¯´æ˜å®ƒé™·å…¥äº†æ­»å¾ªç¯ã€‚è®©æˆ‘ä»¬æ·»åŠ è¿™ä¸ªä¿æŠ¤ï¼š

```typescript
// åœ¨ executeAgent å‡½æ•°ä¸­æ·»åŠ  Doom Loop æ£€æµ‹

const DOOM_LOOP_THRESHOLD = 3
const recentToolCalls: string[] = []

// åœ¨æ¯æ¬¡å·¥å…·è°ƒç”¨åæ£€æŸ¥
const callSignature = `${toolCall.toolName}:${JSON.stringify(toolCall.args)}`
recentToolCalls.push(callSignature)

// æ£€æŸ¥æœ€è¿‘çš„è°ƒç”¨æ˜¯å¦é‡å¤
if (recentToolCalls.length >= DOOM_LOOP_THRESHOLD) {
  const recent = recentToolCalls.slice(-DOOM_LOOP_THRESHOLD)
  const allSame = recent.every((c) => c === recent[0])

  if (allSame) {
    console.log(`âš ï¸ [${agentName}] æ£€æµ‹åˆ° Doom Loopï¼Œå¼ºåˆ¶ç»“æŸ`)
    session.messages.push({
      role: "user",
      content:
        "ä½ ä¼¼ä¹åœ¨é‡å¤ç›¸åŒçš„æ“ä½œã€‚è¯·åœä¸‹æ¥ï¼Œæ€»ç»“ä½ ç›®å‰äº†è§£çš„ä¿¡æ¯ï¼Œ" +
        "ç›´æ¥ç”¨æ–‡å­—å›å¤ã€‚ä¸è¦å†è°ƒç”¨å·¥å…·ã€‚",
    })
    // ä¸ breakï¼Œè®© Agent æœ‰æœºä¼šå“åº”
  }
}
```

## 17.5.6 çŸ¥è¯†ç‚¹æ€»ç»“

é€šè¿‡è¿™ä¸ªå®éªŒï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªåŒ…å«ä»¥ä¸‹æ ¸å¿ƒæœºåˆ¶çš„å¤š Agent ç³»ç»Ÿï¼š

| çŸ¥è¯†ç‚¹ | å¯¹åº”ç« èŠ‚ | å®ç°æ–¹å¼ |
|--------|---------|---------|
| Agent å®šä¹‰ä¸ Prompt å·¥ç¨‹ | ç¬¬ 6 ç«  Agent ç³»ç»Ÿ | `AgentDefinition` + ç²¾å¿ƒè®¾è®¡çš„ System Prompt |
| ä¼šè¯ç®¡ç†ä¸ä¸Šä¸‹æ–‡éš”ç¦» | ç¬¬ 4 ç«  Session ç³»ç»Ÿ | `SessionManager` + çˆ¶å­ä¼šè¯å…³è” |
| Task å·¥å…·ä¸ä»»åŠ¡å§”æ‰˜ | ç¬¬ 5.3.5 èŠ‚ task å·¥å…· | `task` å·¥å…· + `executeAgent()` |
| Agentic Loop | ç¬¬ 4.4 èŠ‚ SessionProcessor | `while` å¾ªç¯ + å·¥å…·è°ƒç”¨æ£€æµ‹ |
| Doom Loop æ£€æµ‹ | ç¬¬ 4.4.2 èŠ‚ | é‡å¤è°ƒç”¨ç­¾åæ£€æŸ¥ |
| å¹¶è¡Œæ‰§è¡Œ | ç¬¬ 15.6.1 èŠ‚åå° Agent | `Promise.allSettled()` |
| é˜²å¾¡å¼ç¼–ç¨‹ | ç¬¬ 15.5 èŠ‚ Hook ç³»ç»Ÿ | é”™è¯¯æ¢å¤ã€è¶…æ—¶ä¿æŠ¤ã€å®‰å…¨æ£€æŸ¥ |

**ä»è¿™ä¸ªå®éªŒåˆ°ç”Ÿäº§çº§äº§å“çš„å·®è·**ï¼š

æˆ‘ä»¬çš„ç®€åŒ–ç‰ˆç³»ç»Ÿè™½ç„¶å±•ç¤ºäº†æ ¸å¿ƒæ¦‚å¿µï¼Œä½†ä¸ OpenCode + oh-my-opencode çš„ç”Ÿäº§çº§å®ç°ç›¸æ¯”ï¼Œè¿˜ç¼ºå°‘ï¼š

1. **æŒä¹…åŒ–å­˜å‚¨**ï¼šæˆ‘ä»¬çš„ä¼šè¯å­˜åœ¨å†…å­˜ä¸­ï¼Œé€€å‡ºå³ä¸¢å¤±ã€‚OpenCode ä½¿ç”¨æ–‡ä»¶å­˜å‚¨ï¼ˆç¬¬ 10 ç« ï¼‰
2. **æµå¼ UI**ï¼šæˆ‘ä»¬åªæœ‰ç®€å•çš„ console.logã€‚OpenCode æœ‰å®Œæ•´çš„ TUIï¼ˆç¬¬ 12 ç« ï¼‰
3. **æƒé™ç³»ç»Ÿ**ï¼šæˆ‘ä»¬çš„å®‰å…¨æ£€æŸ¥æ˜¯ç¡¬ç¼–ç çš„ã€‚OpenCode æœ‰å®Œæ•´çš„æƒé™è¯„ä¼°å¼•æ“ï¼ˆç¬¬ 9 ç« ï¼‰
4. **Snapshot å›æ»š**ï¼šæˆ‘ä»¬æ²¡æœ‰æ–‡ä»¶å˜æ›´å¿«ç…§ã€‚OpenCode å¯ä»¥æ’¤é”€æ‰€æœ‰ä¿®æ”¹ï¼ˆç¬¬ 10.1 èŠ‚ï¼‰
5. **ä¸Šä¸‹æ–‡å‹ç¼©**ï¼šæˆ‘ä»¬æ²¡æœ‰ Compactionã€‚é•¿å¯¹è¯ä¼šè¶…å‡º Token é™åˆ¶ï¼ˆç¬¬ 4.5 èŠ‚ï¼‰
6. **53 ä¸ª Hook**ï¼šoh-my-opencode çš„ Hook ç³»ç»Ÿæä¾›äº†æå…¶ç²¾ç»†çš„è¡Œä¸ºæ§åˆ¶

ä½†æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€æ ·çš„ï¼š**é€šè¿‡ Agent åˆ†å·¥ + å·¥å…·ç³»ç»Ÿ + ä¼šè¯ç®¡ç†ï¼Œæ„å»ºä¸€ä¸ªèƒ½å¤Ÿè‡ªä¸»å®Œæˆå¤æ‚ç¼–ç¨‹ä»»åŠ¡çš„ AI ç³»ç»Ÿ**ã€‚ç†è§£äº†è¿™äº›æ ¸å¿ƒæ¦‚å¿µï¼Œä½ å°±å…·å¤‡äº†ä»é›¶æ„å»ºç±»ä¼¼ç³»ç»Ÿçš„åŸºç¡€ã€‚
