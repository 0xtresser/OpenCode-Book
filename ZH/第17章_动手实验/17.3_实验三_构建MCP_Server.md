# 17.3 å®éªŒä¸‰ï¼šæ„å»ºä¸€ä¸ª MCP Server

> **æ¨¡å‹**: claude-opus-4-6 (anthropic/claude-opus-4-6)  
> **ç”Ÿæˆæ—¥æœŸ**: 2026-02-18

---

ä¸Šä¸¤ä¸ªå®éªŒä¸­æˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå…·å¤‡å¯¹è¯å’Œå·¥å…·è°ƒç”¨èƒ½åŠ›çš„ CLI å·¥å…·ã€‚ä½†é‚£äº›å·¥å…·éƒ½æ˜¯ç¡¬ç¼–ç åœ¨ç¨‹åºå†…éƒ¨çš„â€”â€”å¦‚æœæˆ‘ä»¬æƒ³è®©å·¥å…·å¯ä»¥ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²ã€è¢«å¤šä¸ª AI åº”ç”¨å…±äº«å‘¢ï¼Ÿè¿™å°±æ˜¯ MCPï¼ˆModel Context Protocolï¼‰è¦è§£å†³çš„é—®é¢˜ã€‚

åœ¨ç¬¬ 8 ç« æˆ‘ä»¬åˆ†æäº† OpenCode çš„ MCP Client å®ç°ï¼ˆ`mcp/index.ts`ï¼‰ï¼Œå®ƒä½¿ç”¨ `@modelcontextprotocol/sdk` çš„ `Client` ç±»æ¥è¿æ¥ MCP Serverã€‚æœ¬èŠ‚æˆ‘ä»¬æ¢ä¸€ä¸ªè§’åº¦â€”â€”**è‡ªå·±æ„å»ºä¸€ä¸ª MCP Server**ï¼Œè®© OpenCode èƒ½å¤Ÿè¿æ¥å¹¶ä½¿ç”¨å®ƒã€‚

## 17.3.1 ç›®æ ‡

ä½¿ç”¨ `@modelcontextprotocol/sdk` åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ MCP Serverï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. é€šè¿‡ Stdioï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰ä¼ è¾“åè®®ä¸ Client é€šä¿¡
2. æä¾›ä¸€ä¸ªå®ç”¨çš„å·¥å…·ï¼šGitHub ä»“åº“ä¿¡æ¯æŸ¥è¯¢
3. å°† MCP Server é…ç½®åˆ° OpenCode ä¸­è¿›è¡Œå®é™…æµ‹è¯•

> **è¡ç”Ÿè§£é‡Šâ€”â€”ä¸ºä»€ä¹ˆ MCP ç”¨ Stdio ä¼ è¾“ï¼Ÿ**
>
> MCP æ”¯æŒä¸‰ç§ä¼ è¾“æ–¹å¼ï¼šStdioï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰ã€SSEï¼ˆServer-Sent Eventsï¼‰å’Œ StreamableHTTPã€‚å…¶ä¸­ Stdio æ˜¯æœ€å¸¸è§çš„æœ¬åœ° MCP Server ä¼ è¾“æ–¹å¼ã€‚å®ƒçš„å·¥ä½œåŸç†éå¸¸ç®€å•ï¼š
>
> 1. Clientï¼ˆå¦‚ OpenCodeï¼‰ä»¥å­è¿›ç¨‹æ–¹å¼å¯åŠ¨ Server
> 2. Client é€šè¿‡å­è¿›ç¨‹çš„ `stdin` å‘é€ JSON-RPC è¯·æ±‚
> 3. Server é€šè¿‡ `stdout` è¿”å› JSON-RPC å“åº”
>
> è¿™ç§è®¾è®¡çš„ä¼˜åŠ¿åœ¨äºï¼š**ä¸éœ€è¦ç½‘ç»œç«¯å£ã€ä¸éœ€è¦ HTTP æœåŠ¡å™¨ã€ä¸éœ€è¦å¤„ç†è®¤è¯**â€”â€”åªè¦èƒ½å¯åŠ¨è¿›ç¨‹å°±èƒ½é€šä¿¡ã€‚å¯¹äºæœ¬åœ°å·¥å…·è€Œè¨€ï¼Œè¿™æ˜¯æœ€ç®€å•å¯é çš„æ–¹æ¡ˆã€‚
>
> åœ¨ OpenCode æºç ä¸­ï¼Œ`StdioClientTransport` æ­£æ˜¯è¿™æ ·å®ç°çš„ï¼š
> ```typescript
> const transport = new StdioClientTransport({
>   command: cmd,
>   args,
>   env: { ...process.env, ...mcp.environment },
> })
> ```

## 17.3.2 å®ç°æ­¥éª¤

### æ­¥éª¤ä¸€ï¼šåˆå§‹åŒ–é¡¹ç›®

```bash
mkdir my-mcp-server && cd my-mcp-server
bun init -y
bun add @modelcontextprotocol/sdk zod
```

`@modelcontextprotocol/sdk` æ˜¯ MCP å®˜æ–¹ SDKï¼ŒåŒæ—¶æä¾› Client å’Œ Server ä¸¤ç«¯çš„å®ç°ã€‚

### æ­¥éª¤äºŒï¼šåˆ›å»º MCP Server

åˆ›å»º `server.ts`ï¼š

```typescript
import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js"
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js"
import { z } from "zod"

// åˆ›å»º MCP Server å®ä¾‹
const server = new McpServer({
  name: "github-tools",       // Server åç§°
  version: "1.0.0",           // Server ç‰ˆæœ¬
})

// æ³¨å†Œå·¥å…·ï¼šæŸ¥è¯¢ GitHub ä»“åº“ä¿¡æ¯
server.tool(
  "github_repo_info",                              // å·¥å…·åç§°
  "æŸ¥è¯¢ GitHub ä»“åº“çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬ star æ•°ã€æè¿°ã€è¯­è¨€ç­‰", // å·¥å…·æè¿°
  {
    owner: z.string().describe("ä»“åº“æ‰€æœ‰è€…ï¼ˆç”¨æˆ·åæˆ–ç»„ç»‡åï¼‰"),
    repo: z.string().describe("ä»“åº“åç§°"),
  },
  async ({ owner, repo }) => {
    try {
      const response = await fetch(
        `https://api.github.com/repos/${owner}/${repo}`,
        {
          headers: {
            "Accept": "application/vnd.github.v3+json",
            "User-Agent": "my-mcp-server",
          },
        }
      )

      if (!response.ok) {
        return {
          content: [{
            type: "text" as const,
            text: `é”™è¯¯ï¼šæ— æ³•è·å–ä»“åº“ ${owner}/${repo}ï¼ŒHTTP ${response.status}`,
          }],
        }
      }

      const data = await response.json()

      const info = [
        `ğŸ“¦ ${data.full_name}`,
        `ğŸ“ ${data.description || "æ— æè¿°"}`,
        `â­ ${data.stargazers_count} stars`,
        `ğŸ”€ ${data.forks_count} forks`,
        `ğŸ‘ï¸ ${data.watchers_count} watchers`,
        `ğŸ’» ä¸»è¦è¯­è¨€: ${data.language || "æœªçŸ¥"}`,
        `ğŸ“„ è®¸å¯è¯: ${data.license?.name || "æ— "}`,
        `ğŸ”— ${data.html_url}`,
        `ğŸ“… åˆ›å»ºäº: ${new Date(data.created_at).toLocaleDateString()}`,
        `ğŸ“… æœ€è¿‘æ›´æ–°: ${new Date(data.updated_at).toLocaleDateString()}`,
      ].join("\n")

      return {
        content: [{ type: "text" as const, text: info }],
      }
    } catch (error: any) {
      return {
        content: [{
          type: "text" as const,
          text: `è¯·æ±‚å¤±è´¥: ${error.message}`,
        }],
      }
    }
  }
)

// æ³¨å†Œç¬¬äºŒä¸ªå·¥å…·ï¼šæœç´¢ GitHub ä»“åº“
server.tool(
  "github_search_repos",
  "åœ¨ GitHub ä¸Šæœç´¢ä»“åº“",
  {
    query: z.string().describe("æœç´¢å…³é”®è¯"),
    limit: z.number().min(1).max(10).default(5)
      .describe("è¿”å›ç»“æœæ•°é‡ï¼Œé»˜è®¤ 5"),
  },
  async ({ query, limit }) => {
    try {
      const response = await fetch(
        `https://api.github.com/search/repositories?q=${
          encodeURIComponent(query)
        }&sort=stars&per_page=${limit}`,
        {
          headers: {
            "Accept": "application/vnd.github.v3+json",
            "User-Agent": "my-mcp-server",
          },
        }
      )

      const data = await response.json()

      if (!data.items?.length) {
        return {
          content: [{
            type: "text" as const,
            text: `æœªæ‰¾åˆ°ä¸ "${query}" ç›¸å…³çš„ä»“åº“`,
          }],
        }
      }

      const results = data.items.map((item: any, i: number) =>
        `${i + 1}. ${item.full_name} â­${item.stargazers_count}\n` +
        `   ${item.description || "æ— æè¿°"}\n` +
        `   ${item.html_url}`
      ).join("\n\n")

      return {
        content: [{
          type: "text" as const,
          text: `æœç´¢ "${query}" çš„ç»“æœï¼ˆå…± ${data.total_count} ä¸ªï¼Œæ˜¾ç¤ºå‰ ${limit} ä¸ªï¼‰:\n\n${results}`,
        }],
      }
    } catch (error: any) {
      return {
        content: [{
          type: "text" as const,
          text: `æœç´¢å¤±è´¥: ${error.message}`,
        }],
      }
    }
  }
)

// å¯åŠ¨ Serverï¼Œä½¿ç”¨ Stdio ä¼ è¾“
async function main() {
  const transport = new StdioServerTransport()
  await server.connect(transport)
  // Server ç°åœ¨é€šè¿‡ stdin/stdout ç­‰å¾…è¯·æ±‚
  // æ³¨æ„ï¼šä¸è¦åœ¨ Server ä¸­ä½¿ç”¨ console.logï¼Œå®ƒä¼šå¹²æ‰° Stdio é€šä¿¡
  console.error("GitHub MCP Server å·²å¯åŠ¨")
}

main().catch(console.error)
```

æ³¨æ„å‡ ä¸ªå…³é”®ç‚¹ï¼š

1. **`McpServer` ç±»**ï¼šè¿™æ˜¯ MCP SDK æä¾›çš„é«˜çº§ APIï¼Œæ¯”ç›´æ¥ä½¿ç”¨åº•å±‚çš„ `Server` ç±»æ›´ç®€ä¾¿ã€‚å®ƒå†…ç½®äº†å·¥å…·æ³¨å†Œã€å‚æ•°æ ¡éªŒç­‰åŠŸèƒ½ã€‚

2. **`server.tool()` æ–¹æ³•**ï¼šæ³¨å†Œå·¥å…·çš„ç­¾åæ˜¯ `(name, description, schema, handler)`ï¼Œå…¶ä¸­ `schema` ä½¿ç”¨ Zod å®šä¹‰â€”â€”ä¸ OpenCode å†…éƒ¨çš„ `Tool.define()` é£æ ¼ä¸€è‡´ã€‚

3. **è¿”å›å€¼æ ¼å¼**ï¼šMCP å·¥å…·çš„è¿”å›å€¼å¿…é¡»æ˜¯ `{ content: [{ type: "text", text: string }] }` æ ¼å¼â€”â€”è¿™æ˜¯ MCP åè®®è§„å®šçš„æ ‡å‡†ç»“æ„ã€‚

4. **ä½¿ç”¨ `console.error` è€Œé `console.log`**ï¼šå› ä¸º `stdout` è¢« Stdio ä¼ è¾“å ç”¨ï¼Œä»»ä½•æ—¥å¿—éƒ½å¿…é¡»å†™åˆ° `stderr`ã€‚

### æ­¥éª¤ä¸‰ï¼šæœ¬åœ°æµ‹è¯•

å…ˆç¡®ä¿ Server å¯ä»¥æ­£å¸¸å¯åŠ¨ï¼š

```bash
# ç›´æ¥è¿è¡Œï¼Œåº”è¯¥çœ‹åˆ° stderr ä¸Šçš„å¯åŠ¨æ¶ˆæ¯
# Server ä¼šç­‰å¾… stdin è¾“å…¥ï¼ŒæŒ‰ Ctrl+C é€€å‡º
bun run server.ts
```

### æ­¥éª¤å››ï¼šé…ç½®åˆ° OpenCode

ç¼–è¾‘é¡¹ç›®æ ¹ç›®å½•çš„ `opencode.json`ï¼ˆæˆ– `~/.config/opencode/opencode.json`ï¼‰ï¼š

```json
{
  "mcp": {
    "github-tools": {
      "type": "local",
      "command": ["bun", "run", "/absolute/path/to/my-mcp-server/server.ts"],
      "timeout": 15000
    }
  }
}
```

è¿™ä¸ OpenCode æºç ä¸­ `config/config.ts` å®šä¹‰çš„ `McpLocal` Schema å®Œå…¨å¯¹åº”ï¼š

```typescript
// OpenCode æºç ä¸­çš„ MCP é…ç½®ç±»å‹å®šä¹‰
export const McpLocal = z.object({
  type: z.literal("local"),
  command: z.string().array(),
  environment: z.record(z.string(), z.string()).optional(),
  enabled: z.boolean().optional(),
  timeout: z.number().int().positive().optional(),
})
```

é…ç½®å®Œæˆåï¼Œé‡å¯ OpenCodeï¼Œä½ å°±å¯ä»¥åœ¨å¯¹è¯ä¸­ä½¿ç”¨è¿™ä¸¤ä¸ªå·¥å…·äº†ï¼š

```
You: å¸®æˆ‘æŸ¥ä¸€ä¸‹ anomalyco/opencode è¿™ä¸ªä»“åº“çš„ä¿¡æ¯